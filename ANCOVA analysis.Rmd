---
title: "ANCOVA of protein gorups and pSites"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

```{r setup, include=FALSE}
knitr::opts_chunk$set(collapse=TRUE, comment="##", fig.retina=2, fig.path = "README_figs/README-")
```

Load packages
```{r, include=FALSE}
library(dplyr)
library(ggplot2)
library(reshape2)
library(tidyverse)
library(GGally)
library(ggpubr)
library(ggrepel)
library(qvalue)
library(gridExtra)
library(devtools)
library(ggfortify)
library(limma)
library(plotly)
library(broom)
library(rmotifx)
library(pheatmap)
```

Read in protein groups
```{r}
proteome <- read_csv("./tables/proteinTable.csv")
```

T-test for differential expressing proteins for each time point
```{r}
proteome 
```

ANCOVA for deferentially expressed proteins across timepoint between genotypes 
```{r}
genotype_matched <- proteome %>%
  filter(genotype %in% c("rim15KO","WT")) %>%
  group_by(`Gene names`, samplingTime, replicate, genotype) %>%
  mutate(nutrient_number = n()) %>%
  filter(nutrient_number == 2) %>%
  group_by(`Gene names`, nutrient, samplingTime, replicate) %>%
  mutate(genotype_number = n()) %>%
  filter(genotype_number==2) %>%
  group_by(`Gene names`, nutrient, samplingTime, genotype) %>%
  mutate(rep_numner = n()) %>%
  filter(rep_numner == 3) %>%
  group_by(`Gene names`, nutrient, replicate, genotype) %>%
  mutate(time_number = n()) %>%
  filter(time_number == 4)

ancova_genotype <- genotype_matched %>% 
  mutate(samplingTime = substr(samplingTime, 2, nchar(samplingTime))) %>%
  mutate(samplingTime = as.numeric(samplingTime)) %>%
  dplyr::group_by(nutrient, `Gene names`) %>%
  do(tidy(lm(log10(normalized_intensity) ~ samplingTime * genotype, .))) %>% 
  dplyr::filter(!is.na(p.value)) #%>%

#add q-value
ancova_genotype$qvalue <- qvalue(ancova_genotype$p.value, fdr.level=0.05, pi0.method="bootstrap")$qvalues

#check the distribution of statistics
ancova_genotype %>% 
  ggplot(aes(x=p.value, col = nutrient, fill = nutrient, alpha = 0.2)) + 
  geom_histogram(aes(y=..density..),  position="identity", alpha=0.1)+
  facet_grid( ~ term) +
  scale_color_manual(values=c("#a6beff", "#ff7369"))+
  scale_fill_manual(values=c("#a6beff",  "#ff7369")) +
  theme_classic2() +
  theme(legend.position = "bottom") +
  ggtitle("pvalue")

#check the distribution of coefficient
ancova_genotype %>% 
  ggplot(aes(x=estimate, col = nutrient, fill = nutrient, alpha = 0.2)) + 
  geom_histogram(aes(y=..density..),  position="identity", alpha=0.1)+
  facet_grid( ~ term) +
  scale_color_manual(values=c("#a6beff", "#ff7369"))+
  scale_fill_manual(values=c("#a6beff",  "#ff7369")) +
  theme_classic2() +
  theme(legend.position = "bottom") +
  ggtitle("Coefficient")

#check the distribution of qvalue
ancova_genotype %>% 
  ggplot(aes(x=qvalue, col = nutrient, fill = nutrient, alpha = 0.2)) + 
  geom_histogram(aes(y=..density..),  position="identity", alpha=0.1)+
  facet_grid( ~ term) +
  scale_color_manual(values=c("#a6beff", "#ff7369"))+
  scale_fill_manual(values=c("#a6beff",  "#ff7369")) +
  theme_classic2() +
  theme(legend.position = "bottom")+
  ggtitle("p.adj (FDR = 0.05)")

#look at the significantly differently expressed genes
sig <- ancova_genotype %>% filter(term == "samplingTime:genotypeWT" & qvalue < 0.05)
```

ANCOVA for deferentially expressed proteins across timepoint between conditions 
```{r}
ancova_nutrient <- genotype_matched %>% 
  mutate(samplingTime = substr(samplingTime, 2, nchar(samplingTime))) %>%
  mutate(samplingTime = as.numeric(samplingTime)) %>%
  dplyr::group_by(genotype, `Gene names`) %>%
  do(tidy(lm(log10(normalized_intensity) ~ samplingTime * nutrient, .))) %>% 
  dplyr::filter(!is.na(p.value)) #%>%

#add q-value
ancova_nutrient$qvalue <- qvalue(ancova_nutrient$p.value, fdr.level=0.05, pi0.method="bootstrap")$qvalues

#check the distribution of statistics
ancova_nutrient %>% 
  ggplot(aes(x=p.value, col = genotype, fill = genotype, alpha = 0.2)) + 
  geom_histogram(aes(y=..density..),  position="identity", alpha=0.1)+
  facet_grid( ~ term) +
  scale_color_manual(values=c("#a6beff", "#ff7369"))+
  scale_fill_manual(values=c("#a6beff",  "#ff7369")) +
  theme_classic2() +
  theme(legend.position = "bottom") +
  ggtitle("pvalue")

#check the distribution of coefficient
ancova_nutrient %>% 
  ggplot(aes(x=estimate, col = genotype, fill = genotype, alpha = 0.2)) + 
  geom_histogram(aes(y=..density..),  position="identity", alpha=0.1)+
  facet_grid( ~ term) +
  scale_color_manual(values=c("#a6beff", "#ff7369"))+
  scale_fill_manual(values=c("#a6beff",  "#ff7369")) +
  theme_classic2() +
  theme(legend.position = "bottom") +
  ggtitle("Coefficient")

#check the distribution of qvalue
ancova_nutrient %>% 
  ggplot(aes(x=qvalue, col = genotype, fill = genotype, alpha = 0.2)) + 
  geom_histogram(aes(y=..density..),  position="identity", alpha=0.1)+
  facet_grid( ~ term) +
  scale_color_manual(values=c("#a6beff", "#ff7369"))+
  scale_fill_manual(values=c("#a6beff",  "#ff7369")) +
  theme_classic2() +
  theme(legend.position = "bottom")+
  ggtitle("p.adj (FDR = 0.05)")

#look at the significantly differently expressed genes
sig_nutrient <- ancova_nutrient %>% filter(term == "samplingTime:nutrientP" & qvalue < 0.05)
```

Three-way ANCOVA for differentially expressed proteins across timepoints, bt conditions, and bt genotypes
```{r}
#three way anova using samplingTime, genotype and replicate as variables 
ancova_geno_nutrient <- genotype_matched %>% 
  mutate(samplingTime = substr(samplingTime, 2, nchar(samplingTime))) %>%
  mutate(samplingTime = as.numeric(samplingTime)) %>%
  dplyr::group_by(`Gene names`) %>%
  do(tidy(aov(log10(normalized_intensity) ~ samplingTime * genotype * nutrient, .))) %>% 
  dplyr::filter(!is.na(p.value))
#add q-value
ancova_geno_nutrient$qvalue <- qvalue(ancova_geno_nutrient$p.value, fdr.level=0.05, pi0.method="bootstrap")$qvalues 

#check the distribution of statistics
ancova_geno_nutrient %>% 
  ggplot(aes(x=p.value, col = "#ff7369", alpha = 0.2)) + 
  geom_histogram(aes(y=..density..), col = "#ff7369", position="identity", alpha=0.1)+
  facet_grid( ~ term) +
   theme_classic2() +
  theme(legend.position = "bottom") +
  ggtitle("pvalue")

#check the distribution of coefficient
ancova_geno_nutrient %>% 
  ggplot(aes(x=sumsq, col = "#ff7369", alpha = 0.2)) + 
  geom_histogram(aes(y=..density..), col = "#ff7369", position="identity", alpha=0.1)+
  facet_grid( ~ term) +
  theme_classic2() +
  theme(legend.position = "bottom") +
  ggtitle("sum of square root")

#check the distribution of qvalue
ancova_geno_nutrient %>% 
  ggplot(aes(x=qvalue, col = "#ff7369", alpha = 0.2)) + 
  geom_histogram(aes(y=..density..), col = "#ff7369", position="identity", alpha=0.1)+
  facet_grid( ~ term) +
  theme_classic2() +
  theme(legend.position = "bottom")+
  ggtitle("p.adj (FDR = 0.05)")

sig_geno <- ancova_geno_nutrient %>% filter(term == "samplingTime:genotype" & qvalue < 0.05)
sig_nutri <- ancova_geno_nutrient %>% filter(term == "samplingTime:nutrient" & qvalue < 0.05)
```



